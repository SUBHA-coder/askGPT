<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskGPT</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus"></i> New chat
                </button>
            </div>
            
            <div class="chat-history">
                <div class="history-list" id="historyList">
                    <!-- Chat history will be populated here -->
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user-name">{{.User.Username}}</span>
                </div>
                <a href="/logout" class="logout-btn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </aside>

        <main class="main-content">
            <div class="chat-container">
                <div class="messages" id="messages">
                    {{if not .Messages}}
                    <div class="welcome-screen">
                        <h1>Welcome to AskGPT</h1>
                        <div class="examples">
                            <h2>Examples</h2>
                            <div class="example-grid">
                                <button class="example-btn">"Explain quantum computing"</button>
                                <button class="example-btn">"Write a poem about spring"</button>
                                <button class="example-btn">"How do I make pasta?"</button>
                            </div>
                        </div>
                    </div>
                    {{end}}
                    
                    {{range .Messages}}
                    <div class="message {{if contains . "You:"}}user-message{{else}}ai-message{{end}}">
                        <div class="avatar">
                            {{if contains . "You:"}}
                            <i class="fas fa-user"></i>
                            {{else}}
                            <i class="fas fa-robot"></i>
                            {{end}}
                        </div>
                        <div class="message-content">
                            {{if contains . "You:"}}
                                {{trimPrefix . "You: "}}
                            {{else}}
                                {{$content := trimPrefix . "AI: "}}
                                {{formatMessage $content}}
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>

                <div class="chat-input-container">
                    <form id="chat-form" class="chat-form">
                        <div class="input-wrapper">
                            <textarea 
                                id="message" 
                                name="message" 
                                placeholder="Send a message..."
                                rows="1"
                                required
                            ></textarea>
                            <button type="submit" class="send-button">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                    <div class="input-footer">
                        <p>AskGPT can make mistakes. Consider checking important information.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // WebSocket connection
        const ws = new WebSocket('ws://' + window.location.host + '/ws');
        const messagesDiv = document.getElementById('messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message');
        const newChatBtn = document.getElementById('newChatBtn');

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Handle new chat button
        newChatBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/new-chat', {
                    method: 'POST',
                });

                if (response.ok) {
                    messagesDiv.innerHTML = '';
                    showWelcomeScreen();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Handle chat form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Add user message to chat
            addMessage('You: ' + message, 'user-message');

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'message=' + encodeURIComponent(message)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                addMessage('Error: Failed to send message', 'error-message');
            }
        });

        // Handle WebSocket messages
        ws.onmessage = function(event) {
            removeTypingIndicator();
            addMessage(event.data, event.data.startsWith('You:') ? 'user-message' : 'ai-message');
        };

        // Helper functions
        function formatMessage(text) {
            // Check if the text contains code blocks
            if (text.includes('```')) {
                return text.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, language, code) {
                    return `
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-language">${language || 'plaintext'}</span>
                                <button class="copy-button" onclick="copyCode(this)">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <pre><code class="${language}">${escapeHtml(code.trim())}</code></pre>
                        </div>
                    `;
                });
            }
            
            // Check for inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert URLs to links
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            // Convert newlines to <br>
            return text.replace(/\n/g, '<br>');
        }

        function addMessage(text, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + className;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            avatarDiv.innerHTML = className === 'user-message' ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Remove prefix and format content
            const content = text.replace(/^(You: |AI: )/, '');
            contentDiv.innerHTML = className === 'user-message' ? 
                content : 
                formatMessage(content);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // Initialize syntax highlighting for code blocks
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function copyCode(button) {
            const codeBlock = button.closest('.code-block').querySelector('code');
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const icon = button.querySelector('i');
                icon.className = 'fas fa-check';
                setTimeout(() => {
                    icon.className = 'fas fa-copy';
                }, 2000);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message ai-message typing-indicator';
            indicator.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            indicator.id = 'typing-indicator';
            messagesDiv.appendChild(indicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function showWelcomeScreen() {
            const welcomeScreen = `
                <div class="welcome-screen">
                    <h1>Welcome to AskGPT</h1>
                    <div class="examples">
                        <h2>Examples</h2>
                        <div class="example-grid">
                            <button class="example-btn">"Explain quantum computing"</button>
                            <button class="example-btn">"Write a poem about spring"</button>
                            <button class="example-btn">"How do I make pasta?"</button>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.innerHTML = welcomeScreen;
            setupExampleButtons();
        }

        function setupExampleButtons() {
            document.querySelectorAll('.example-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const text = button.textContent.replace(/['"]/g, '');
                    messageInput.value = text;
                    chatForm.dispatchEvent(new Event('submit'));
                });
            });
        }

        // Initial setup
        setupExampleButtons();
    </script>
</body>
</html> 