<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskGo AI Assistant</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <button class="new-chat-btn">
                <i class="fas fa-plus"></i> New Chat
            </button>
            <div class="chat-history">
                <h3>Chat History</h3>
                <div id="historyList">
                    <!-- Chat history will be populated here -->
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="chat-container" id="chatContainer">
                {{range .Messages}}
                <div class="message-container">
                    <div class="message {{if contains . "You:"}}user-message{{else}}ai-message{{end}}">
                        <div class="message-content">{{.}}</div>
                    </div>
                </div>
                {{end}}
                <div id="typingIndicator" class="typing-indicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
            <form id="chatForm" class="input-form">
                <div class="input-wrapper">
                    <div class="textarea-container">
                        <textarea name="message" placeholder="Type your message here..." required></textarea>
                        <div class="char-counter">0/4000</div>
                    </div>
                    <button type="submit" title="Send (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            // Configure marked
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true
            });

            // Auto-scroll to bottom
            function scrollToBottom() {
                $('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);
            }
            scrollToBottom();

            // Handle form submission
            $('#chatForm').on('submit', function(e) {
                e.preventDefault();
                const message = $('textarea[name="message"]').val();
                if (!message.trim()) return;

                // Add user message
                const userMessageHtml = `
                    <div class="message-container">
                        <div class="message user-message">
                            <div class="message-content">You: ${message}</div>
                        </div>
                    </div>
                `;
                $('#chatContainer').append(userMessageHtml);
                $('textarea[name="message"]').val('');
                updateCharCounter();
                scrollToBottom();

                // Show typing indicator
                $('#typingIndicator').show();
                scrollToBottom();

                // Send message to server
                $.ajax({
                    url: '/chat',
                    method: 'POST',
                    data: { message: message },
                    success: function(response) {
                        $('#typingIndicator').hide();
                        location.reload();
                    },
                    error: function() {
                        $('#typingIndicator').hide();
                        alert('Error sending message');
                    }
                });
            });

            // Handle new chat button
            $('.new-chat-btn').on('click', function() {
                if (confirm('Start a new chat? This will clear the current conversation.')) {
                    $.ajax({
                        url: '/new-chat',
                        method: 'POST',
                        success: function() {
                            location.reload();
                        }
                    });
                }
            });

            // Auto-resize textarea
            $('textarea').on('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                updateCharCounter();
            });

            // Character counter
            function updateCharCounter() {
                const text = $('textarea[name="message"]').val();
                const count = text.length;
                $('.char-counter').text(`${count}/4000`);
                if (count > 4000) {
                    $('.char-counter').addClass('error');
                } else {
                    $('.char-counter').removeClass('error');
                }
            }

            // Process markdown and syntax highlighting
            $('.message-content').each(function() {
                const content = $(this).text();
                if (content.startsWith('AI:')) {
                    const markdownContent = content.substring(3);
                    $(this).html(marked.parse(markdownContent));
                    
                    // Add copy buttons to code blocks
                    $(this).find('pre').each(function() {
                        const copyButton = $('<button class="copy-button" title="Copy code"><i class="fas fa-copy"></i></button>');
                        $(this).prepend(copyButton);
                    });
                }
            });

            // Apply syntax highlighting
            $('pre code').each(function() {
                hljs.highlightElement(this);
            });

            // Handle copy button clicks
            $('.copy-button').on('click', function() {
                const codeBlock = $(this).siblings('code');
                const code = codeBlock.text();
                navigator.clipboard.writeText(code).then(() => {
                    $(this).html('<i class="fas fa-check"></i>');
                    setTimeout(() => {
                        $(this).html('<i class="fas fa-copy"></i>');
                    }, 2000);
                });
            });

            // Keyboard shortcuts
            $('textarea').on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    $('#chatForm').submit();
                }
            });
        });
    </script>
</body>
</html> 